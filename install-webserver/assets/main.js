"use strict";var E=Object.create;var d=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var w=Object.getOwnPropertyNames;var P=Object.getPrototypeOf,j=Object.prototype.hasOwnProperty;var I=(n,o,e,t)=>{if(o&&typeof o=="object"||typeof o=="function")for(let r of w(o))!j.call(n,r)&&r!==e&&d(n,r,{get:()=>o[r],enumerable:!(t=S(o,r))||t.enumerable});return n};var p=(n,o,e)=>(e=n!=null?E(P(n)):{},I(o||!n||!n.__esModule?d(e,"default",{value:n,enumerable:!0}):e,n));var c=p(require("os")),i=p(require("path")),s=p(require("fs")),a=require("electron"),u=i.join(c.homedir(),".slack-plugin-thingy","plugins"),_=i.join(c.homedir(),".slack-plugin-thingy"),g=i.join(c.homedir(),".slack-plugin-thingy","preload.js"),h=i.join(c.homedir(),".slack-plugin-thingy","config.json"),m=()=>{try{if(s.existsSync(h)){let n=s.readFileSync(h,"utf8");return JSON.parse(n)}}catch(n){console.error("Config Load Error",n)}return{serverUrl:"",pluginsEnabled:[]}};a.ipcMain.on("SLACKMOD_GET_CONFIG",n=>{let o=m();n.returnValue=o});a.ipcMain.on("SLACKMOD_GET_PLUGINS",n=>{try{if(!s.existsSync(u)){n.returnValue=[];return}let e=s.readdirSync(u,{withFileTypes:!0}).filter(r=>r.isDirectory()).map(r=>r.name),t=[];for(let r of e){let l=i.join(u,r,"manifest.json");if(s.existsSync(l))try{let f=s.readFileSync(l,"utf8"),y=JSON.parse(f);t.push({id:r,manifest:y})}catch(f){console.error("Manifest Error",f)}}n.returnValue=t}catch(o){console.error("Plugin List Error",o),n.returnValue=[]}});a.ipcMain.on("SLACKMOD_READ_FILE",(n,o)=>{try{let e=o.pluginId?i.join(u,o.pluginId):i.join(c.homedir(),".slack-plugin-thingy"),t=i.join(e,o.filePath);if(!t.startsWith(e)){console.error("Blocked illegal path access:",t),n.returnValue=null;return}if(s.existsSync(t)){let r=s.readFileSync(t,"utf8");n.returnValue=r}else n.returnValue=null}catch(e){console.error("Read File Error",e),n.returnValue=null}});a.app.once("browser-window-created",(n,o)=>{let e=o.webContents.session.getPreloads()??[];e.includes(g)||(o.webContents.session.setPreloads([...e,g]),console.log("[SlackMod] Injected custom preload"))});var A=["preload.js","main.js","plugin-manager.js"],C=async()=>{let n=m();for(let o of A){let e=n.serverUrl+"/"+o;try{let t=await fetch(e);if(!t.ok){console.error(`Failed to fetch ${e}: ${t.statusText}`);continue}let r=await t.text(),l=i.join(_,o);s.promises.writeFile(l,r,"utf8"),console.log(`[SlackMod] Updated ${o} successfully.`)}catch(t){console.error(`Error updating ${o}:`,t)}}};a.ipcMain.on("SLACKMOD_UPDATE_FILES",async n=>{await C(),n.returnValue=!0});
