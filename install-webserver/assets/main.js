"use strict";var j=Object.create;var g=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var O=Object.getPrototypeOf,V=Object.prototype.hasOwnProperty;var C=(n,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of D(e))!V.call(n,s)&&s!==t&&g(n,s,{get:()=>e[s],enumerable:!(i=b(e,s))||i.enumerable});return n};var p=(n,e,t)=>(t=n!=null?j(O(n)):{},C(e||!n||!n.__esModule?g(t,"default",{value:n,enumerable:!0}):t,n));var L=p(require("os")),a=p(require("path")),r=p(require("fs")),c=require("electron"),f=a.join(L.homedir(),".slack-plugin-thingy"),u=a.join(f,"plugins"),h=a.join(f,"config.json"),_=a.join(f,"preload.js"),d=a.join(f,"themes"),o=()=>{try{if(r.existsSync(h))return JSON.parse(r.readFileSync(h,"utf8"))}catch{}return{serverUrl:"",pluginsEnabled:[],themesEnabled:[]}},S=n=>{r.mkdirSync(f,{recursive:!0}),r.writeFileSync(h,JSON.stringify(n,null,2))};c.ipcMain.on("SLACKMOD_GET_CONFIG",n=>{n.returnValue=o()});c.ipcMain.on("SLACKMOD_GET_PLUGINS",n=>{try{if(!r.existsSync(u)){n.returnValue=[];return}let e=r.readdirSync(u,{withFileTypes:!0}).filter(s=>s.isDirectory()).map(s=>s.name),t=[];for(let s of e){let l=a.join(u,s,"manifest.json");if(r.existsSync(l))try{t.push({id:s,manifest:JSON.parse(r.readFileSync(l,"utf8")),enabled:!1})}catch{}}let i=o();for(let s of t)s.enabled=!!i.pluginsEnabled.find(l=>l.id===s.id);n.returnValue=t}catch{n.returnValue=[]}});c.ipcMain.on("SLACKMOD_GET_THEMES",n=>{try{if(!r.existsSync(d)){n.returnValue=[];return}let e=r.readdirSync(d,{withFileTypes:!0}).filter(s=>s.isDirectory()).map(s=>s.name),t=[];for(let s of e){let l=a.join(d,s,"manifest.json");if(r.existsSync(l))try{t.push({id:s,manifest:JSON.parse(r.readFileSync(l,"utf8")),enabled:!1})}catch{}}let i=o();for(let s of t)s.enabled=i.themesEnabled.includes(s.id);n.returnValue=t}catch{n.returnValue=[]}});c.app.once("browser-window-created",(n,e)=>{let t=e.webContents.session.getPreloads()||[];t.includes(_)||e.webContents.session.setPreloads([...t,_])});var F=["preload.js","main.js","plugin-manager.js","plugin-manager.css"],A=async()=>{let n=o();for(let e of F){let t=n.serverUrl+"/"+e;try{let i=await fetch(t);if(!i.ok)continue;let s=await i.text();r.writeFileSync(a.join(f,e),s)}catch{}}};c.ipcMain.on("SLACKMOD_UPDATE_FILES",async n=>{await A(),n.returnValue=!0});c.ipcMain.on("SLACKMOD_SET_PLUGIN_ENABLED",(n,e)=>{let t=o();t.pluginsEnabled.find(i=>i.id===e.pluginId)||(t.pluginsEnabled.push({id:e.pluginId,manifest:{}}),S(t)),n.returnValue=!0});c.ipcMain.on("SLACKMOD_GET_FILE",(n,e)=>{try{let t=e.pluginId?a.join(u,e.pluginId):f,i=a.join(t,e.filePath);if(!i.startsWith(t)){n.returnValue=null;return}if(r.existsSync(i)){n.returnValue=r.readFileSync(i,"utf8");return}}catch{}n.returnValue=null});c.ipcMain.on("SLACKMOD_SET_PLUGIN_DISABLED",(n,e)=>{let t=o();t.pluginsEnabled=t.pluginsEnabled.filter(i=>i.id!==e.pluginId),S(t),n.returnValue=!0});c.ipcMain.on("SLACKMOD_ENABLE_THEME",(n,e)=>{let t=o();t.themesEnabled.includes(e)||(t.themesEnabled.push(e),S(t)),n.returnValue=!0});c.ipcMain.on("SLACKMOD_DISABLE_THEME",(n,e)=>{let t=o();t.themesEnabled=t.themesEnabled.filter(i=>i!==e),S(t),n.returnValue=!0});c.ipcMain.on("SLACKMOD_GET_THEME_CSS",(n,e)=>{try{let t=a.join(d,e,"theme.css");if(r.existsSync(t)){n.returnValue=r.readFileSync(t,"utf8");return}}catch{}n.returnValue=null});c.ipcMain.on("SLACKMOD_GET_PLUGIN_CODE",(n,e)=>{try{let t=a.join(u,e,"manifest.json");if(!r.existsSync(t)){n.returnValue={code:null,css:null};return}let i=JSON.parse(r.readFileSync(t,"utf8")),s=i.entry||"index.js",l=a.join(u,e,s),y=null;r.existsSync(l)&&(y=r.readFileSync(l,"utf8"));let E=null;if(i.css){let m=a.join(u,e,i.css);r.existsSync(m)&&(E=r.readFileSync(m,"utf8"))}n.returnValue={code:y,css:E};return}catch{}n.returnValue={code:null,css:null}});
